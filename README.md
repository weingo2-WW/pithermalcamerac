# A Raspberry Pi MLX9064 Thermal Camera C Interface
I decided to rewrite most of tomshaffner/PiThermalCam in C because the python dependencies were too bloated and slow for my pi zero W. 
However, the PiThermalCam project is still a great project if you feel differently about python and dependency management. 
The interface with the MLX9064 is a rewritten version of adafruit_mlx90640.py in C.
The code is C++ because it is required for the opencv interface.
This library is desined to be performant on the pi zero W.

## Compiling
Dependencies:
```
sudo apt-get install libopencv-dev libbcm2835-dev g++
```
Compiling:
```
make
```
Ideally, you should not have to compile if you are using raspberian OS and the 32-bit version of the pi. However, the included binary could have other issues.

## Example
```
Usage: sudo ./thermal [-hgvnf] [-b baud_rate] [-r refresh_rate]
        -g uses greyscale instead of the jet colorscale
        -b changes the baud rate using the bcm2835 library. Default is your system default.
        -r changes the default refresh rate of 4 Hz. Values are 0, 2, 4, 6, 8, 16, 32, 64.
        -v outputs to a video using ffmpeg
        -n disables python fileserver for web stream
        -f computes ideal refresh rate and exits
        -h displays the usage message and exits
```
Running 
```
sudo ./thermal
```
will start a web server using python -m http.server and start grabbing images from the MLX9064.
Here is an example of the out.jpg image generated by the thermal binary:

![Thermal Image of Me](/out_example.jpg)

### Recomendations
The bcm2835 library does not like to set baud rates above 200000 on my pi zero W. The MLX9064 advertises a 1MHz baud rate so, to achieve this rate I recomend setting the baud_rate in your /boot/firmware/config.txt to
```
dtparam=i2c_arm=on,i2c_arm_baudrate=1000000
```
This provides the best possible transfer rate and best cpu efficiency. With this setting I can almost achieve 16fps but I left the default at 4 fps to save some energy when powered by a battery and keep the program from crashing at low default baud rates.

## Install as a systemd service
Add the binary and service to the global path locations (aka installing).
```
sudo cp thermal /usr/bin/thermal
sudo cp thermal.service /usr/lib/systemd/system
sudo mkdir /usr/share/thermal
sudo cp index.html /usr/share/thermal
```
Enable and start the service
```
sudo systemctl enable --now thermal
```
Now a instance of thermal should be running with the default settings streaming on port 8000!
This service will automatically startup whenever the pi is booted up.

